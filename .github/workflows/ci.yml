name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

on:
  push:
    branches: ['**']
    paths-ignore: ['**/*.md', 'docs/**']
  pull_request:
    paths-ignore: ['**/*.md', 'docs/**']
  schedule:
    # Daglig körning för Linux & Windows (02:00 UTC)
    - cron: "0 2 * * *"
    # Veckovis körning för macOS (Måndagar kl 03:00 UTC)
    - cron: "0 3 * * 1"
  workflow_dispatch:

jobs:
  validate-local-checks:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      - name: Install project dependencies (hash-locked) + cyclonedx-bom
        run: |
          python -m pip install --upgrade pip
          pip install --require-hashes -r requirements.lock
          python -m pip install cyclonedx-bom
      - uses: pre-commit/action@v3.0.1
        env:
          PYTHONPATH: .
          SKIP: sbom-generate
        with:
          extra_args: --all-files --hook-stage push

  prepare-repo:
    # Create a single repository artifact so subsequent jobs do not need to
    # perform `actions/checkout` themselves. This allows us to run a single
    # networked checkout early (when egress is open) and then let hardened
    # jobs download the artifact without contacting github.com.
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Pack repository
        run: |
          # Create an archive from the committed tree to avoid race conditions
          # where files are modified while tar is reading them (causes tar error).
          # `git archive` exports the stable HEAD snapshot which is unaffected
          # by runtime modifications to the working directory.
          git archive --format=tar HEAD | gzip > repo.tar.gz
      - name: Upload repository artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo
          path: repo.tar.gz

  branch-quick-matrix:
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: ${{ matrix.python-version == '3.14' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
          cache: 'pip'
      - name: Install dependencies
        continue-on-error: ${{ matrix.python-version == '3.14' }}
        run: pip install --require-hashes -r requirements.lock
      - name: Quick tests (single seed, no coverage)
        continue-on-error: ${{ matrix.python-version == '3.14' }}
        env:
          PYTHONPATH: .
        run: pytest -q --maxfail=1 --randomly-seed=1 tests

  nightly-matrix:
    if: github.event.schedule == '0 2 * * *'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    continue-on-error: ${{ matrix.python-version == '3.14' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
          cache: 'pip'
      - name: Install dependencies
        run: pip install --require-hashes -r requirements.lock
      - name: Run tests with two random seeds
        env:
          PYTHONPATH: .
        run: |
          pytest --randomly-seed=1 tests
          pytest --randomly-seed=2 tests

  weekly-macos-matrix:
    if: github.event.schedule == '0 3 * * 1'
    runs-on: macos-latest
    timeout-minutes: 60
    continue-on-error: ${{ matrix.python-version == '3.14' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
          cache: 'pip'
      - name: Install dependencies
        run: pip install --require-hashes -r requirements.lock
      - name: Run tests with two random seeds
        env:
          PYTHONPATH: .
        run: |
          pytest --randomly-seed=1 tests
          pytest --randomly-seed=2 tests

  lint-and-types:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: prepare-repo
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            storage.googleapis.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            codeload.github.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          # Include a few GitHub action related hostnames which runner
          # background processes may contact during job startup.
          endpoints=( \
            "https://api.github.com" \
            "https://raw.githubusercontent.com" \
            "https://codeload.github.com" \
            "https://results-receiver.actions.githubusercontent.com" \
            "https://actions-results-receiver-production.githubapp.com" \
            "https://hosted-compute-watchdog-prod-iad-01.githubapp.com" \
            "https://productionresultssa12.blob.core.windows.net" \
          )
          tries=12
          delay=2
          for u in "${endpoints[@]}"; do
            ok=0
            for i in $(seq 1 $tries); do
              if curl -sS --max-time 8 -I "$u" >/dev/null 2>&1; then
                ok=1
                break
              fi
              echo "WARN: cannot reach $u (attempt $i/$tries), sleeping $delay"
              sleep $delay
            done
            if [ $ok -ne 1 ]; then
              echo "ERROR: cannot reach $u after $tries attempts" >&2
              exit 1
            fi
          done
          # Ensure a clearly disallowed host is not reachable
          if curl -sS --max-time 8 -I https://example.com >/dev/null 2>&1; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - name: Cleanup mutants and caches
        shell: bash
        run: |
          rm -rf mutants .pytest_cache .mypy_cache .ruff_cache || true
          find . -type d -name __pycache__ -prune -exec rm -rf {} + || true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install requirements (hash-locked)
        run: |
          python -m pip install --upgrade pip
          pip install --require-hashes -r requirements.lock
      - name: Ruff (lint)
        run: ruff check . --output-format=github
      - name: Pre-commit (format & hooks)
        run: pre-commit run --all-files --show-diff-on-failure
      - name: Mypy (strict)
        run: mypy --strict src setup_project.py

  security:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: prepare-repo
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            storage.googleapis.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            codeload.github.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          endpoints=( "https://api.github.com" "https://raw.githubusercontent.com" "https://codeload.github.com" )
          for u in "${endpoints[@]}"; do
            if ! curl -sS --max-time 8 -I "$u" >/dev/null; then
              echo "ERROR: cannot reach $u" >&2
              exit 1
            fi
          done
          if curl -sS --max-time 8 -I https://example.com >/dev/null; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install requirements (hash-locked)
        run: |
          python -m pip install --upgrade pip
          pip install --require-hashes -r requirements.lock
          pip check
      - name: Bandit (MEDIUM+)
        run: bandit -r src/ -x tests -ll
      - name: pip-audit (deps)
        run: pip-audit --requirement requirements.lock --strict --ignore-vuln PYSEC-2022-42969
      - name: License allowlist
        run: python tools/policy/check_licenses.py
      # --- SBOM EFTER licenskollen ---
      - name: SBOM (CycloneDX via python -m)
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install cyclonedx-bom
          python -m cyclonedx_py environment -o sbom.json --output-format json
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.python-version }}
          path: sbom.json

  secrets-scan:
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: prepare-repo
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            api.github.com:443
            codeload.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          endpoints=( "https://api.github.com" "https://raw.githubusercontent.com" "https://codeload.github.com" )
          for u in "${endpoints[@]}"; do
            if ! curl -sS --max-time 8 -I "$u" >/dev/null; then
              echo "ERROR: cannot reach $u" >&2
              exit 1
            fi
          done
          if curl -sS --max-time 8 -I https://example.com >/dev/null; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - name: Gitleaks (secrets)
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  tests:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    needs: [lint-and-types, security, secrets-scan]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']
        include:
          - os: ubuntu-latest
            python-version: '3.11'
            codecov-flag: 'ubuntu-py311'
          - os: ubuntu-latest
            python-version: '3.12'
            codecov-flag: 'ubuntu-py312'
          - os: ubuntu-latest
            python-version: '3.13'
            codecov-flag: 'ubuntu-py313'
          - os: windows-latest
            python-version: '3.11'
            codecov-flag: 'windows-py311'
          - os: windows-latest
            python-version: '3.12'
            codecov-flag: 'windows-py312'
          - os: windows-latest
            python-version: '3.13'
            codecov-flag: 'windows-py313'
          - os: macos-latest
            python-version: '3.11'
            codecov-flag: 'macos-py311'
          - os: macos-latest
            python-version: '3.12'
            codecov-flag: 'macos-py312'
          - os: macos-latest
            python-version: '3.13'
            codecov-flag: 'macos-py313'
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            storage.googleapis.com:443
            codeload.github.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          endpoints=( "https://api.github.com" "https://raw.githubusercontent.com" "https://codeload.github.com" )
          for u in "${endpoints[@]}"; do
            if ! curl -sS --max-time 8 -I "$u" >/dev/null; then
              echo "ERROR: cannot reach $u" >&2
              exit 1
            fi
          done
          if curl -sS --max-time 8 -I https://example.com >/dev/null; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - name: Cleanup mutants and caches
        shell: bash
        run: |
          rm -rf mutants .pytest_cache .mypy_cache .ruff_cache || true
          find . -type d -name __pycache__ -prune -exec rm -rf {} + || true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install deps (hash-locked)
        run: |
          python -m pip install --upgrade pip
          pip install --require-hashes -r requirements.lock
      - name: Pytest (seed=1, coverage 100%, branch coverage)
        env:
          PYTHONPATH: .
        run: |
          pytest -q --maxfail=1 --randomly-seed=1 \
            --cov=src --cov=setup_project --cov-branch \
            --cov-report=term-missing --cov-report=xml --cov-fail-under=100 \
            tests
      - name: Pytest (seed=2, order-independence check)
        env:
          PYTHONPATH: .
        run: |
          pytest -q --maxfail=1 --randomly-seed=2 tests
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7
        with:
          files: ./coverage.xml
          flags: ${{ matrix.codecov-flag }}
          fail_ci_if_error: true
          verbose: true

  mutation-testing:
    name: mutation-testing
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: [tests]
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          endpoints=( "https://api.github.com" "https://raw.githubusercontent.com" "https://codeload.github.com" )
          for u in "${endpoints[@]}"; do
            if ! curl -sS --max-time 8 -I "$u" >/dev/null; then
              echo "ERROR: cannot reach $u" >&2
              exit 1
            fi
          done
          if curl -sS --max-time 8 -I https://example.com >/dev/null; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - name: Cleanup mutants and caches
        shell: bash
        run: |
          rm -rf mutants .pytest_cache .mypy_cache .ruff_cache || true
          find . -type d -name __pycache__ -prune -exec rm -rf {} + || true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install deps (hash-locked)
        run: |
          python -m pip install --upgrade pip
          pip install --require-hashes -r requirements.lock
      - name: Run mutation tests (mutmut)
        env:
          PYTHONPATH: .
        run: |
          mutmut run
      - name: Fail if any mutants survived
        env:
          PYTHONPATH: .
        run: |
          survivors=$(mutmut results | grep -c "survived" || true)
          echo "Survivors: $survivors"
          if [ "$survivors" -ne 0 ]; then
            echo "ERROR: Some mutants survived. Failing build." >&2
            exit 1
          fi

  semgrep:
    name: semgrep
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    needs: prepare-repo
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            semgrep.dev:443
            registry.semgrep.dev:443
            codeload.github.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          endpoints=( "https://api.github.com" "https://raw.githubusercontent.com" "https://codeload.github.com" )
          for u in "${endpoints[@]}"; do
            if ! curl -sS --max-time 8 -I "$u" >/dev/null; then
              echo "ERROR: cannot reach $u" >&2
              exit 1
            fi
          done
          if curl -sS --max-time 8 -I https://example.com >/dev/null; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - name: Semgrep (p/ci, fail on high severity)
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d
        with:
          config: p/ci
          generateSarif: true
          sarifFile: semgrep.sarif
          auditOn: pull_request
          # Only treat high-severity issues as failures
          semgrep_args: --severity=ERROR

  dependency-review:
    name: dependency-review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: prepare-repo
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          endpoints=( "https://api.github.com" "https://raw.githubusercontent.com" "https://codeload.github.com" )
          for u in "${endpoints[@]}"; do
            if ! curl -sS --max-time 8 -I "$u" >/dev/null; then
              echo "ERROR: cannot reach $u" >&2
              exit 1
            fi
          done
          if curl -sS --max-time 8 -I https://example.com >/dev/null; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - name: Dependency Review (fail on high severity)
        uses: actions/dependency-review-action@c6c4c1745020c2dd28bf84835cf10d0e8c8a450f
        with:
          fail-on-severity: high

  docs-quality:
    name: docs-quality
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: [prepare-repo, lint-and-types]
    steps:
      - name: Download repository artifact
        uses: actions/download-artifact@v4
        with:
          name: repo
          path: repo_artifact
      - name: Extract repository
        run: |
          tar -xzf repo_artifact/repo.tar.gz -C .
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            codeload.github.com:443
      - name: Verify Harden Runner
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          endpoints=( "https://api.github.com" "https://raw.githubusercontent.com" "https://codeload.github.com" )
          for u in "${endpoints[@]}"; do
            if ! curl -sS --max-time 8 -I "$u" >/dev/null; then
              echo "ERROR: cannot reach $u" >&2
              exit 1
            fi
          done
          if curl -sS --max-time 8 -I https://example.com >/dev/null; then
            echo "ERROR: disallowed host reachable (policy not applied)" >&2
            exit 1
          fi
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install deps (hash-locked)
        run: |
          python -m pip install --upgrade pip
          pip install --require-hashes -r requirements.lock
      - name: Interrogate (docstring coverage 100%)
        run: |
          interrogate -v --fail-under 100 src/
