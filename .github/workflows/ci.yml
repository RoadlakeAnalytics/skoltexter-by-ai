name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

on:
  push:
    branches: ['**']
    paths-ignore: ['**/*.md', 'docs/**']
  pull_request:
    paths-ignore: ['**/*.md', 'docs/**']
  schedule:
    - cron: "0 2 * * *"
    - cron: "0 3 * * 1"
  workflow_dispatch:

jobs:
  validate-local-checks:
    # This job provides quick local-only checks but requires the prepared
    # offline artifacts (lockfiles/wheelhouse) to run offline; ensure it
    # waits for `prepare-artifacts`.
    needs: prepare-artifacts
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Restore repository
        uses: ./.github/actions/restore-repo
        with:
          artifact-name: repo
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            codeload.github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            results-receiver.actions.githubusercontent.com:443
            actions-results-receiver-production.githubapp.com:443
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            storage.googleapis.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            uploads.codecov.io:443
            static.codecov.io:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            productionresultssa12.blob.core.windows.net:443
            productionresultssa9.blob.core.windows.net:443
            agent.api.stepsecurity.io:443
      - name: Download lockfiles artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-3.12
          path: lockfiles

      - name: Download wheelhouse artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-3.12
          path: wheelhouse

      - name: Install project dependencies (hash-locked) + cyclonedx-bom
        run: |
          # Do not upgrade pip in offline/hardened jobs; print version for diagnostics
          python -m pip --version
          LOCKFILE=lockfiles/requirements.lock-3.12
          WHEEL=wheelhouse/3.12
          if [ -d "$WHEEL" ] && [ -f "$LOCKFILE" ]; then
            pip install --no-index --find-links "$WHEEL" --require-hashes -r "$LOCKFILE"
          elif [ -f "$LOCKFILE" ]; then
            pip install --require-hashes -r "$LOCKFILE"
          else
            pip install --require-hashes -r requirements.lock
          fi
          # Attempt offline install of SBOM tooling from the wheelhouse to avoid
          # network egress in hardened jobs. If the package is not present in
          # the wheelhouse, skip installation rather than attempting a network
          # fetch which will fail under the hardened runner.
          if [ -d "$WHEEL" ]; then
            if pip install --no-index --find-links "$WHEEL" cyclonedx-bom; then
              echo "Installed cyclonedx-bom from wheelhouse"
            elif pip install --no-index --find-links "$WHEEL" cyclonedx-python-lib; then
              echo "Installed cyclonedx-python-lib (provides cyclonedx_py) from wheelhouse"
            else
              echo "WARNING: cyclonedx-bom not found in wheelhouse; skipping SBOM tooling installation to avoid network egress"
            fi
          else
            echo "WARNING: wheelhouse not present; skipping cyclonedx-bom installation to avoid network egress"
          fi
      # Run local checks directly to avoid network fetches performed by
      # pre-commit when installing external hook repositories (e.g. psf/black).
      # These checks mirror the repository-local pre-commit hooks and operate
      # offline using packages installed from the wheelhouse.
      - name: Cleanup mutants and caches
        env:
          PYTHONPATH: .
        run: python tools/ci/cleanup_caches.py

      - name: Pip check (installed deps)
        env:
          PYTHONPATH: .
        run: python tools/ci/pip_check.py

      - name: License allowlist
        env:
          PYTHONPATH: .
        run: python tools/policy/check_licenses.py

      - name: Interrogate (docstring coverage)
        env:
          PYTHONPATH: .
        run: interrogate -v --fail-under 100 src/

  pack-repo:
    # Create a single repository artifact so subsequent jobs do not need to
    # perform `actions/checkout` themselves. This allows a single networked
    # checkout early (when egress is open) and lets hardened jobs download the
    # artifact without contacting github.com.
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Pack repository
        run: |
          git archive --format=tar HEAD | gzip > repo.tar.gz
      - name: Upload repository artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo
          path: repo.tar.gz

  fetch-osv-db:
    # Fetch the OSV bulk vulnerability database with unrestricted egress.
    # This job runs after `pack-repo` and uploads an `osv-db` artifact that
    # hardened/offline jobs can later download. It intentionally does NOT use
    # the hardened-runner so it can reach CDNs and other hosts needed for the
    # vulnerability database bulk download.
    needs: pack-repo
    runs-on: ubuntu-latest
    steps:
      - name: Download OSV vulnerability database (bulk)
        run: |
          set -euo pipefail
          # Public, verifiable URL chosen by the team (visible in workflow):
          OSV_URL="https://osv-vulnerabilities.storage.googleapis.com/PyPI/all.zip"
          echo "Downloading OSV bulk database from: $OSV_URL"
          mkdir -p vuln-db vuln-db/extracted
          curl -fsSL "$OSV_URL" -o vuln-db/all.zip
          unzip -q vuln-db/all.zip -d vuln-db/extracted || true
          # Prefer a single consolidated JSON if present; otherwise concatenate
          # JSON files found inside the archive into a single file for offline use.
          FIRST_JSON=$(find vuln-db/extracted -type f -name 'all.json' -o -name '*.json' | head -n 1 || true)
          if [ -n "$FIRST_JSON" ]; then
            COUNT=$(find vuln-db/extracted -type f -name '*.json' | wc -l || true)
            if [ "$COUNT" -eq 1 ]; then
              cp "$FIRST_JSON" vuln-db/osv.json
            else
              # Concatenate multiple JSON files as newline-delimited records.
              find vuln-db/extracted -type f -name '*.json' -print0 | xargs -0 cat > vuln-db/osv.json
            fi
          else
            echo "ERROR: No JSON files found inside downloaded OSV archive" >&2
            exit 1
          fi
      - name: Upload OSV database artifact
        uses: actions/upload-artifact@v4
        with:
          name: osv-db
          path: vuln-db

  generate-locks:
    # Ensure we only start generating locks after the repository has been
    # packed. This lets `pack-repo` finish and then run two parallel tracks:
    #  - fast checks (needs: pack-repo)
    #  - dependency generation (this job)
    needs: pack-repo
    # Matrix job: create one lockfile+wheelhouse per Python version. Each
    # matrix axis is independent so a failure for one Python version does not
    # prevent others from completing. 3.14 is explicitly allowed to fail.
    # Use a direct checkout here so generate-locks does not have to wait on
    # the separate `pack-repo` job; this reduces the overall critical path.
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    continue-on-error: ${{ matrix.python-version == '3.14' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Generate lockfile and wheelhouse
        run: |
          # Install pip-tools. Prefer the version pinned in requirements.lock
          # to avoid surprising incompatibilities with newer pip internals.
          echo "Before install: python -m pip --version"
          python -m pip --version || true

          # Extract pip-tools version from requirements.lock robustly. The
          # lockfile contains line-continuations ("\") after package lines,
          # so avoid naively splitting on '==' which can capture the trailing
          # backslash. We extract the full line and then parse the version.
          PT_LINE=$(awk '/^pip-tools==/ {print; exit}' requirements.lock || true)
          PT_VER=""
          if [ -n "$PT_LINE" ]; then
            # Extract a sane version token (digits/letters/dot/+-) from the line.
            PT_VER=$(printf "%s" "$PT_LINE" | sed -E 's/^pip-tools==([0-9A-Za-z.+-]+).*/\1/')
            # Defensive: strip any stray backslashes or whitespace
            PT_VER=$(printf "%s" "$PT_VER" | tr -d '\\' | tr -d '\r' | tr -d '[:space:]')
          fi
          if [ -n "$PT_VER" ]; then
            echo "Installing pip-tools==$PT_VER (from requirements.lock)"
            python -m pip install "pip-tools==$PT_VER"
          else
            echo "pip-tools not pinned in requirements.lock; installing latest pip-tools"
            python -m pip install pip-tools
          fi
          echo "After install: python -m pip --version"
          python -m pip --version || true
          echo "pip-compile version and pip-tools info:" 
          pip-compile --version || true
          python -m pip show pip-tools || true
          mkdir -p lockfiles
          pip-compile --allow-unsafe --generate-hashes --no-emit-index-url --output-file=lockfiles/requirements.lock-${{ matrix.python-version }} requirements.txt
          mkdir -p wheelhouse/${{ matrix.python-version }}
          pip download --no-deps -r lockfiles/requirements.lock-${{ matrix.python-version }} -d wheelhouse/${{ matrix.python-version }}
      - name: Upload lockfile artifact
        uses: actions/upload-artifact@v4
        with:
          name: lockfiles-${{ matrix.python-version }}
          path: lockfiles/requirements.lock-${{ matrix.python-version }}
      - name: Upload wheelhouse artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheelhouse-${{ matrix.python-version }}
          path: wheelhouse/${{ matrix.python-version }}

  prepare-artifacts:
    # Aggregate per-version artifacts produced by `generate-locks` into the
    # consolidated `lockfiles` and `wheelhouse` artifacts consumed by the rest
    # of the workflow. Missing per-version artifacts are tolerated.
    needs: generate-locks
    runs-on: ubuntu-latest
    steps:
      - name: Make temp folders
        run: mkdir -p temp/lockfiles temp/wheelhouse lockfiles wheelhouse
      - name: Download lockfiles 3.11
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: lockfiles-3.11
          path: temp/lockfiles/3.11
      - name: Download lockfiles 3.12
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: lockfiles-3.12
          path: temp/lockfiles/3.12
      - name: Download lockfiles 3.13
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: lockfiles-3.13
          path: temp/lockfiles/3.13
      - name: Download lockfiles 3.14
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: lockfiles-3.14
          path: temp/lockfiles/3.14
      - name: Download wheelhouse 3.11
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wheelhouse-3.11
          path: temp/wheelhouse/3.11
      - name: Download wheelhouse 3.12
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wheelhouse-3.12
          path: temp/wheelhouse/3.12
      - name: Download wheelhouse 3.13
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wheelhouse-3.13
          path: temp/wheelhouse/3.13
      - name: Download wheelhouse 3.14
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wheelhouse-3.14
          path: temp/wheelhouse/3.14
      - name: Assemble artifacts
        run: |
          set -euo pipefail
          mkdir -p lockfiles
          mkdir -p wheelhouse
          for v in 3.11 3.12 3.13 3.14; do
            if [ -f temp/lockfiles/${v}/requirements.lock-${v} ]; then
              cp temp/lockfiles/${v}/requirements.lock-${v} lockfiles/ || true
            fi
            if [ -d temp/wheelhouse/${v} ]; then
              mkdir -p wheelhouse/${v}
              cp -r temp/wheelhouse/${v}/* wheelhouse/${v}/ || true
            fi
          done
      - name: Upload lockfiles artifact
        uses: actions/upload-artifact@v4
        with:
          name: lockfiles
          path: lockfiles
      - name: Upload wheelhouse artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheelhouse
          path: wheelhouse

  branch-quick-matrix:
    # Branch quick matrix depends on prepared artifacts (lockfiles/wheelhouse)
    # so it must wait for the consolidated `prepare-artifacts` job to finish.
    needs: prepare-artifacts
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Allow Python 3.14 to fail: Ecosystem libraries (pytest, etc.) not yet fully compatible
    continue-on-error: ${{ matrix.python-version == '3.14' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
          cache: 'pip'
      - name: Download lockfiles artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-${{ matrix.python-version }}
          path: lockfiles

      - name: Download wheelhouse artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-${{ matrix.python-version }}
          path: wheelhouse

      - name: Install dependencies
        # Allow Python 3.14 to fail: Ecosystem libraries not yet fully compatible
        continue-on-error: ${{ matrix.python-version == '3.14' }}
        run: |
          # Do not upgrade pip here; print current pip version instead
          python -m pip --version
          LOCK=lockfiles/requirements.lock-${{ matrix.python-version }}
          WHEEL=wheelhouse/${{ matrix.python-version }}
          if [ -d "$WHEEL" ] && [ -f "$LOCK" ]; then
            pip install --no-index --find-links "$WHEEL" --require-hashes -r "$LOCK"
          elif [ -f "$LOCK" ]; then
            pip install --require-hashes -r "$LOCK"
          else
            pip install --require-hashes -r requirements.lock
          fi
      - name: Quick tests (single seed, no coverage)
        # Allow Python 3.14 to fail: Ecosystem libraries not yet fully compatible
        continue-on-error: ${{ matrix.python-version == '3.14' }}
        env:
          PYTHONPATH: .
        run: pytest -q --maxfail=1 --randomly-seed=1 tests

  nightly-matrix:
    # Ensure per-version lockfiles/wheelhouses are generated before scheduled runs.
    needs: generate-locks
    if: github.event.schedule == '0 2 * * *'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    # Allow Python 3.14 to fail: Ecosystem libraries (pytest, etc.) not yet fully compatible
    continue-on-error: ${{ matrix.python-version == '3.14' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
          cache: 'pip'
      - name: Download lockfiles artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-${{ matrix.python-version }}
          path: lockfiles

      - name: Download wheelhouse artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-${{ matrix.python-version }}
          path: wheelhouse

      - name: Install dependencies
        run: |
          # Do not upgrade pip here; print current pip version instead
          python -m pip --version
          LOCK=lockfiles/requirements.lock-${{ matrix.python-version }}
          WHEEL=wheelhouse/${{ matrix.python-version }}
          if [ -d "$WHEEL" ] && [ -f "$LOCK" ]; then
            pip install --no-index --find-links "$WHEEL" --require-hashes -r "$LOCK"
          elif [ -f "$LOCK" ]; then
            pip install --require-hashes -r "$LOCK"
          else
            pip install --require-hashes -r requirements.lock
          fi
      - name: Run tests with two random seeds
        env:
          PYTHONPATH: .
        run: |
          pytest --randomly-seed=1 tests
          pytest --randomly-seed=2 tests

  weekly-macos-matrix:
    # Ensure per-version lockfiles are generated before scheduled macOS runs.
    needs: generate-locks
    if: github.event.schedule == '0 3 * * 1'
    runs-on: macos-latest
    timeout-minutes: 60
    # Allow Python 3.14 to fail: Ecosystem libraries (pytest, etc.) not yet fully compatible
    continue-on-error: ${{ matrix.python-version == '3.14' }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
          cache: 'pip'
      - name: Download lockfiles artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-${{ matrix.python-version }}
          path: lockfiles

      - name: Install dependencies
        run: |
          # Do not upgrade pip here; print current pip version instead
          python -m pip --version
          LOCK=lockfiles/requirements.lock-${{ matrix.python-version }}
          if [ -f "$LOCK" ]; then
            pip install --require-hashes -r "$LOCK"
          else
            pip install --require-hashes -r requirements.lock
          fi
      - name: Run tests with two random seeds
        env:
          PYTHONPATH: .
        run: |
          pytest --randomly-seed=1 tests
          pytest --randomly-seed=2 tests

  lint-and-types:
    # Fast feedback job: only needs the packed repository. It can run
    # immediately after `pack-repo` without waiting for lockfile/wheelhouse
    # preparation.
    needs: pack-repo
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - name: Restore repository
        uses: ./.github/actions/restore-repo
        with:
          artifact-name: repo

      - name: Cleanup mutants and caches
        shell: bash
        run: |
          rm -rf mutants .pytest_cache .mypy_cache .ruff_cache || true
          find . -type d -name __pycache__ -prune -exec rm -rf {} + || true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff black mypy

      - name: Ruff (lint)
        run: ruff check . --output-format=github

      - name: Black (format check)
        run: python -m black --check . --line-length=88

      - name: Mypy (strict)
        run: mypy --strict src setup_project.py

  security:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    needs: [prepare-artifacts, fetch-osv-db]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            codeload.github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            results-receiver.actions.githubusercontent.com:443
            actions-results-receiver-production.githubapp.com:443
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            storage.googleapis.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            uploads.codecov.io:443
            static.codecov.io:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            productionresultssa12.blob.core.windows.net:443
            productionresultssa9.blob.core.windows.net:443
            agent.api.stepsecurity.io:443

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Download lockfiles artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-${{ matrix.python-version }}
          path: lockfiles

      - name: Download wheelhouse artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-${{ matrix.python-version }}
          path: wheelhouse

      - name: Download OSV database artifact
        uses: actions/download-artifact@v4
        with:
          name: osv-db
          path: osv-db

      - name: Verify offline artifacts
        run: |
          LOCK=lockfiles/requirements.lock-${{ matrix.python-version }}
          WHEEL=wheelhouse/${{ matrix.python-version }}
          bash tools/ci/verify_offline_artifacts.sh "$LOCK" "$WHEEL"

      - name: Install requirements (hash-locked)
        uses: ./.github/actions/install-deps
        with:
          lockfile: lockfiles/requirements.lock-${{ matrix.python-version }}
          wheel-dir: wheelhouse/${{ matrix.python-version }}
      - name: Bandit (MEDIUM+)
        run: bandit -r src/ -x tests -ll
      # CVE PYSEC-2022-42969 ignored: This issue affects the 'py' library.
      # It is a disputed ReDoS vulnerability in SVN info parsing that security researchers
      # have deemed non-reproducible under real-world conditions. Our dependency on 'py'
      # is limited to development and testing (via pytest), with no exposure in production.
      - name: pip-audit (deps) (offline)
        run: |
          pip-audit --requirement requirements.lock --strict --ignore-vuln PYSEC-2022-42969 --disable-pip --database osv-db/osv.json
      - name: License allowlist
        run: python tools/policy/check_licenses.py
      # SBOM AFTER license check
      - name: SBOM (CycloneDX via python -m)
        shell: bash
        run: |
          # Do not upgrade pip here; print current pip version instead
          python -m pip --version
          # Try to install SBOM tooling from local wheelhouse to avoid network egress
          WHEEL=wheelhouse/${{ matrix.python-version }}
          if [ -d "$WHEEL" ]; then
            if pip install --no-index --find-links "$WHEEL" cyclonedx-bom; then
              echo "Installed cyclonedx-bom from wheelhouse"
            elif pip install --no-index --find-links "$WHEEL" cyclonedx-python-lib; then
              echo "Installed cyclonedx-python-lib (provides cyclonedx_py) from wheelhouse"
            else
              echo "WARNING: cyclonedx tooling not found in wheelhouse; skipping SBOM generation to avoid network egress"
              exit 0
            fi
          else
            echo "WARNING: wheelhouse not present; skipping SBOM generation to avoid network egress"
            exit 0
          fi
          python -m cyclonedx_py environment -o sbom.json --output-format json
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.python-version }}
          path: sbom.json

  secrets-scan:
    # Fast feedback job: only needs repository content. Run as soon as
    # `pack-repo` completes.
    needs: pack-repo
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    steps:
      - name: Restore repository
        uses: ./.github/actions/restore-repo
        with:
          artifact-name: repo

      - name: Gitleaks (secrets)
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  tests:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    needs: [lint-and-types, security, secrets-scan]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']
        include:
          - os: ubuntu-latest
            python-version: '3.11'
            codecov-flag: 'ubuntu-py311'
          - os: ubuntu-latest
            python-version: '3.12'
            codecov-flag: 'ubuntu-py312'
          - os: ubuntu-latest
            python-version: '3.13'
            codecov-flag: 'ubuntu-py313'
          - os: windows-latest
            python-version: '3.11'
            codecov-flag: 'windows-py311'
          - os: windows-latest
            python-version: '3.12'
            codecov-flag: 'windows-py312'
          - os: windows-latest
            python-version: '3.13'
            codecov-flag: 'windows-py313'
          - os: macos-latest
            python-version: '3.11'
            codecov-flag: 'macos-py311'
          - os: macos-latest
            python-version: '3.12'
            codecov-flag: 'macos-py312'
          - os: macos-latest
            python-version: '3.13'
            codecov-flag: 'macos-py313'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            codeload.github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            results-receiver.actions.githubusercontent.com:443
            actions-results-receiver-production.githubapp.com:443
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            storage.googleapis.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            uploads.codecov.io:443
            static.codecov.io:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            productionresultssa12.blob.core.windows.net:443
            productionresultssa9.blob.core.windows.net:443
            agent.api.stepsecurity.io:443
      - name: Cleanup mutants and caches
        shell: bash
        run: |
          rm -rf mutants .pytest_cache .mypy_cache .ruff_cache || true
          find . -type d -name __pycache__ -prune -exec rm -rf {} + || true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Download lockfiles artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-${{ matrix.python-version }}
          path: lockfiles

      - name: Download wheelhouse artifact (per-version)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-${{ matrix.python-version }}
          path: wheelhouse

      - name: Install deps (hash-locked)
        uses: ./.github/actions/install-deps
        with:
          lockfile: lockfiles/requirements.lock-${{ matrix.python-version }}
          wheel-dir: wheelhouse/${{ matrix.python-version }}
      - name: Pytest (seed=1, coverage 100%, branch coverage)
        env:
          PYTHONPATH: .
        run: |
          pytest -q --maxfail=1 --randomly-seed=1 \
            --cov=src --cov=setup_project --cov-branch \
            --cov-report=term-missing --cov-report=xml --cov-fail-under=100 \
            tests
      - name: Pytest (seed=2, order-independence check)
        env:
          PYTHONPATH: .
        run: |
          pytest -q --maxfail=1 --randomly-seed=2 tests
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7
        with:
          files: ./coverage.xml
          flags: ${{ matrix.codecov-flag }}
          fail_ci_if_error: true
          verbose: true

  mutation-testing:
    name: mutation-testing
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: [tests]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            codeload.github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            results-receiver.actions.githubusercontent.com:443
            actions-results-receiver-production.githubapp.com:443
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            storage.googleapis.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            uploads.codecov.io:443
            static.codecov.io:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            productionresultssa12.blob.core.windows.net:443
            productionresultssa9.blob.core.windows.net:443
            agent.api.stepsecurity.io:443
      - name: Cleanup mutants and caches
        shell: bash
        run: |
          rm -rf mutants .pytest_cache .mypy_cache .ruff_cache || true
          find . -type d -name __pycache__ -prune -exec rm -rf {} + || true
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Download lockfiles artifact (3.12)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-3.12
          path: lockfiles

      - name: Download wheelhouse artifact (3.12)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-3.12
          path: wheelhouse

      - name: Verify offline artifacts
        run: |
          # mutation-testing runs on Python 3.12 in this workflow. Verify that
          # the per-version lockfile and wheelhouse are present for offline
          # installation before attempting to install packages.
          LOCK=lockfiles/requirements.lock-3.12
          WHEEL=wheelhouse/3.12
          bash tools/ci/verify_offline_artifacts.sh "$LOCK" "$WHEEL"

      - name: Install deps (hash-locked)
        uses: ./.github/actions/install-deps
        with:
          lockfile: lockfiles/requirements.lock-3.12
          wheel-dir: wheelhouse/3.12
      - name: Run mutation tests (mutmut)
        env:
          PYTHONPATH: .
        run: |
          mutmut run
      - name: Fail if any mutants survived
        env:
          PYTHONPATH: .
        run: |
          survivors=$(mutmut results | grep -c "survived" || true)
          echo "Survivors: $survivors"
          if [ "$survivors" -ne 0 ]; then
            echo "ERROR: Some mutants survived. Failing build." >&2
            exit 1
          fi

  semgrep:
    name: semgrep
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    needs: pack-repo
    steps:
      - name: Restore repository
        uses: ./.github/actions/restore-repo
        with:
          artifact-name: repo
      - name: Semgrep (p/ci, fail on high severity)
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d
        with:
          config: p/ci
          generateSarif: true
          sarifFile: semgrep.sarif
          auditOn: pull_request
          # Only treat high-severity issues as failures
          semgrep_args: --severity=ERROR

  dependency-review:
    name: dependency-review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: pack-repo
    steps:
      - name: Restore repository
        uses: ./.github/actions/restore-repo
        with:
          artifact-name: repo
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            codeload.github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            results-receiver.actions.githubusercontent.com:443
            actions-results-receiver-production.githubapp.com:443
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            storage.googleapis.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            uploads.codecov.io:443
            static.codecov.io:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            productionresultssa12.blob.core.windows.net:443
            productionresultssa9.blob.core.windows.net:443
            agent.api.stepsecurity.io:443
      - name: Dependency Review (fail on high severity)
        uses: actions/dependency-review-action@c6c4c1745020c2dd28bf84835cf10d0e8c8a450f
        with:
          fail-on-severity: high

  docs-quality:
    name: docs-quality
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    # Docs quality needs both lint results and the prepared offline artifacts
    # (lockfiles/wheelhouse). Wait for `prepare-artifacts` and `lint-and-types`.
    needs: [prepare-artifacts, lint-and-types]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Harden Runner
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a
        with:
          egress-policy: block
          allowed-endpoints: |
            github.com:443
            codeload.github.com:443
            api.github.com:443
            raw.githubusercontent.com:443
            objects.githubusercontent.com:443
            uploads.github.com:443
            results-receiver.actions.githubusercontent.com:443
            actions-results-receiver-production.githubapp.com:443
            pypi.org:443
            files.pythonhosted.org:443
            pypi.python.org:443
            pip.pypa.io:443
            storage.googleapis.com:443
            codecov.io:443
            api.codecov.io:443
            uploader.codecov.io:443
            uploads.codecov.io:443
            static.codecov.io:443
            ghcr.io:443
            pkg-containers.githubusercontent.com:443
            registry.semgrep.dev:443
            semgrep.dev:443
            osv.dev:443
            api.osv.dev:443
            productionresultssa12.blob.core.windows.net:443
            productionresultssa9.blob.core.windows.net:443
            agent.api.stepsecurity.io:443
      
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Download lockfiles artifact (3.12)
        uses: actions/download-artifact@v4
        with:
          name: lockfiles-3.12
          path: lockfiles

      - name: Download wheelhouse artifact (3.12)
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse-3.12
          path: wheelhouse

      - name: Verify offline artifacts
        run: |
          LOCK=lockfiles/requirements.lock-3.12
          WHEEL=wheelhouse/3.12
          bash tools/ci/verify_offline_artifacts.sh "$LOCK" "$WHEEL"

      - name: Install deps (hash-locked)
        run: |
          # Do not upgrade pip here; print current pip version instead
          python -m pip --version
          LOCK=lockfiles/requirements.lock-3.12
          WHEEL=wheelhouse/3.12
          if [ -d "$WHEEL" ] && [ -f "$LOCK" ]; then
            pip install --no-index --find-links "$WHEEL" --require-hashes -r "$LOCK"
          elif [ -f "$LOCK" ]; then
            pip install --require-hashes -r "$LOCK"
          else
            pip install --require-hashes -r requirements.lock
          fi
      - name: Interrogate (docstring coverage 100%)
        run: |
          interrogate -v --fail-under 100 src/
