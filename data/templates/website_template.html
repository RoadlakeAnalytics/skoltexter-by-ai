<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>Skolinformation</title>
    <!-- Google Fonts for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Pico.css for a clean classless baseline -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --surface: #ffffff;
            --surface-2: #f0f2f5;
            --text: #2b2b2b;
            --muted: #6c757d;
            --primary: #0d6efd;
            --primary-strong: #0b5ed7;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border: #d0d7de;
            --table-border: #dee2e6;
        }
        :root[data-theme="dark"] {
            --surface: #121212;
            --surface-2: #0e0e0e;
            --text: #e6e6e6;
            --muted: #a0a0a0;
            --primary: #66a3ff;
            --primary-strong: #8ab6ff;
            --card-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
            --border: #2a2f3a;
            --table-border: #3a3f4a;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --surface: #121212;
                --surface-2: #0e0e0e;
                --text: #e6e6e6;
                --muted: #a0a0a0;
                --primary: #66a3ff;
                --primary-strong: #8ab6ff;
                --card-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
                --border: #2a2f3a;
                --table-border: #3a3f4a;
            }
        }
        /* Base */
        body {
            margin: 0;
            background-color: var(--surface-2);
            font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 860px;
            margin: 2rem auto;
            background: var(--surface);
            padding: 0;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-strong));
            color: white;
            padding: 1.5rem 2rem;
            text-align: center;
            font-size: 1.4em;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.2px;
        }
        .content {
            padding: 1.5rem 2rem 2rem 2rem;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 1.25rem;
            font-weight: 700;
            color: var(--primary-strong);
            text-align: center;
        }
        input[type="search"], select {
            width: 100%;
            padding: 0.85rem 1rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--surface);
            color: var(--text);
            box-sizing: border-box;
            appearance: none;
        }
        select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.41.59L6 5.17L10.59.59L12 2L6 8L0 2L1.41.59Z" fill="%23bbbbbb"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
        }
        select:focus, input[type="search"]:focus {
            border-color: var(--primary);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, .25);
        }
        .school-info-wrapper { margin-top: 0; padding: 0; background-color: transparent; border: none; }
        .school-content { overflow-wrap: break-word; color: var(--text); line-height: 1.5; }
        .school-content * { margin-top: 0; }

        .school-content h1, .school-content h2, .school-content h3,
        .school-content h4, .school-content h5, .school-content h6 {
            color: var(--primary-strong);
            font-weight: 600;
        }
        .school-content h1 { font-size: 1.8em; margin-top: 1.1em !important; margin-bottom: 0.55em; }
        .school-content h1:first-child { margin-top: 0 !important; }
        .school-content h2 { font-size: 1.35em; margin-top: 1em !important; margin-bottom: 0.45em; }
        .school-content h3 { font-size: 1.15em; margin-top: 0.85em !important; margin-bottom: 0.35em; }
        .school-content h4, .school-content h5, .school-content h6 { font-size: 1.02em; margin-top: 0.6em !important; margin-bottom: 0.25em; }
        .school-content p { margin-bottom: 0.7em; }
        .school-content h1 + *, .school-content h2 + *, .school-content h3 + *, .school-content h4 + *, .school-content h5 + *, .school-content h6 + * { margin-top: 0 !important; }
        .school-content ul, .school-content ol { padding-left: 1.5em; margin-bottom: 0.6em; margin-top: 0 !important; }
        .school-content li { margin-bottom: 0.25em; }
        .school-content br { line-height: 0; }
        .school-content br + br { display: none; }
        .school-content table { width: 100%; border-collapse: collapse; margin-bottom: 0.8em; }
        .school-content th, .school-content td { border: 1px solid var(--table-border); padding: 0.6em; text-align: left; }
        .school-content th { background-color: color-mix(in hsl, var(--primary) 10%, transparent); }
        .placeholder-text { color: var(--muted); text-align: center; padding: 2rem 0; }

        /* Live search results panel */
        .search-summary { color: var(--muted); font-size: 0.92rem; margin-top: -0.4rem; margin-bottom: 0.25rem; }
        .search-results { list-style: none; margin: 0.25rem 0 0.75rem 0; padding: 0; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); max-height: 240px; overflow: auto; }
        .search-result-item { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: color-mix(in hsl, var(--primary) 8%, transparent); }
        .search-result-item.active { background: color-mix(in hsl, var(--primary) 18%, transparent); }
        .search-result-name { font-weight: 500; }
        .search-result-id { color: var(--muted); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            Skolinformation
            <div style="float:right; font-size: 0.8em; font-weight: 400; display:flex; gap:.75rem; align-items:center;">
                <label for="theme-select" style="color:#fff; opacity:.9;">Tema:</label>
                <select id="theme-select" style="min-width:120px;">
                    <option value="auto" selected>Auto</option>
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
        </div>
        <div class="content">
            <input id="school-filter" type="search" placeholder="Sök skola..." aria-label="Sök skola" />
            <div id="search-summary" class="search-summary">Skriv för att filtrera skolor…</div>
            <ul id="search-results" class="search-results" aria-live="polite" aria-label="Sökträffar"></ul>
            <select id="school-select">
                <option value="">-- Välj en skola --</option>
            </select>
            <div id="school-details-placeholder" class="placeholder-text">
                <p>Välj en skola från rullgardinsmenyn för att se dess detaljer.</p>
            </div>
            <div id="school-details-content" style="display:none;"></div>
        </div>
    </div>
    <script>
        // Parse the school data passed from Python
        const schools = {school_list_json};
        const selectElement = document.getElementById('school-select');
        const filterInput = document.getElementById('school-filter');
        const detailsPlaceholder = document.getElementById('school-details-placeholder');
        const detailsContentContainer = document.getElementById('school-details-content');
        const searchSummary = document.getElementById('search-summary');
        const searchResults = document.getElementById('search-results');
        let currentResults = [];
        let activeIndex = -1;

        // Theme handling (persist selection)
        const themeSelect = document.getElementById('theme-select');
        function applyTheme(mode) {
            if (mode === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else if (mode === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }
        const savedTheme = localStorage.getItem('site-theme') || 'auto';
        themeSelect.value = savedTheme;
        applyTheme(savedTheme);
        themeSelect.addEventListener('change', () => {
            localStorage.setItem('site-theme', themeSelect.value);
            applyTheme(themeSelect.value);
        });

        // Populate the dropdown menu with school options
        function populateOptions(items) {
            // Preserve the first placeholder option
            const firstOption = selectElement.querySelector('option[value=""]');
            selectElement.innerHTML = '';
            if (firstOption) selectElement.appendChild(firstOption);
            items.forEach((school) => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                selectElement.appendChild(option);
            });
        }

        populateOptions(schools);

        function updateSearchPanel(items, query) {
            // When no query: show instruction and hide results panel
            if (!query) {
                searchSummary.textContent = 'Skriv för att filtrera skolor…';
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }
            // With a query: show results count and render list
            const label = items.length === 1 ? 'träff' : 'träffar';
            searchSummary.textContent = `${items.length} ${label}`;
            searchResults.style.display = 'block';
            currentResults = items;
            activeIndex = -1;
            // Rebuild results list (cap for readability)
            const MAX_SHOW = 12;
            searchResults.innerHTML = '';
            const subset = items.slice(0, MAX_SHOW);
            subset.forEach((s) => {
                const li = document.createElement('li');
                li.className = 'search-result-item';
                li.setAttribute('role', 'button');
                li.dataset.id = s.id;
                const nameSpan = document.createElement('span');
                nameSpan.className = 'search-result-name';
                nameSpan.textContent = s.name || s.id;
                const idSpan = document.createElement('span');
                idSpan.className = 'search-result-id';
                idSpan.textContent = `(${s.id})`;
                li.appendChild(nameSpan);
                li.appendChild(idSpan);
                li.addEventListener('click', () => {
                    selectElement.value = s.id;
                    selectElement.dispatchEvent(new Event('change'));
                });
                searchResults.appendChild(li);
            });
            if (items.length > MAX_SHOW) {
                const more = document.createElement('li');
                more.className = 'search-result-item';
                more.style.cursor = 'default';
                more.textContent = `… visar ${MAX_SHOW} av ${items.length}`;
                searchResults.appendChild(more);
            }
        }

        function setActive(index) {
            const items = Array.from(searchResults.querySelectorAll('.search-result-item'));
            // Ignore the trailing "… visar" row, which lacks data-id
            const actionable = items.filter((el) => el.dataset && el.dataset.id);
            actionable.forEach((el) => el.classList.remove('active'));
            if (!actionable.length) {
                activeIndex = -1;
                return;
            }
            // Clamp and wrap
            if (index < 0) index = actionable.length - 1;
            if (index >= actionable.length) index = 0;
            activeIndex = index;
            const el = actionable[activeIndex];
            el.classList.add('active');
            // Ensure visibility
            el.scrollIntoView({ block: 'nearest' });
        }

        // Live filter the schools by name or code
        filterInput.addEventListener('input', function () {
            const q = filterInput.value.trim().toLowerCase();
            if (!q) {
                populateOptions(schools);
                updateSearchPanel(schools, q);
                // Reset selection and details when query is cleared
                selectElement.value = '';
                detailsPlaceholder.style.display = 'block';
                detailsContentContainer.style.display = 'none';
                detailsContentContainer.innerHTML = '';
                return;
            }
            const filtered = schools.filter((s) =>
                (s.name || '').toLowerCase().includes(q) || (s.id || '').toLowerCase().includes(q)
            );
            populateOptions(filtered);
            updateSearchPanel(filtered, q);
            if (filtered.length === 1) {
                // Auto-select the single remaining school and show details
                selectElement.value = filtered[0].id;
                selectElement.dispatchEvent(new Event('change'));
            } else {
                // Reset content area when filtering to multiple results
                selectElement.value = '';
                detailsPlaceholder.style.display = 'block';
                detailsContentContainer.style.display = 'none';
                detailsContentContainer.innerHTML = '';
            }
        });

        // Keyboard navigation for results: up/down to move, Enter to select
        filterInput.addEventListener('keydown', function (e) {
            const q = filterInput.value.trim().toLowerCase();
            const hasQuery = q.length > 0 && searchResults.style.display !== 'none';
            if (!hasQuery) return;
            const actionable = Array.from(searchResults.querySelectorAll('.search-result-item')).filter((el) => el.dataset && el.dataset.id);
            if (!actionable.length) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                setActive(activeIndex + 1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                setActive(activeIndex <= 0 ? actionable.length - 1 : activeIndex - 1);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const pick = activeIndex >= 0 ? actionable[activeIndex] : actionable[0];
                if (pick && pick.dataset && pick.dataset.id) {
                    selectElement.value = pick.dataset.id;
                    selectElement.dispatchEvent(new Event('change'));
                }
            }
        });

        // Initialize search panel on load
        updateSearchPanel(schools, '');

        // Listen for selection changes and display the school description
        selectElement.addEventListener('change', function() {
            const selectedSchoolId = selectElement.value;

            if (!selectedSchoolId) {
                detailsPlaceholder.style.display = 'block';
                detailsContentContainer.style.display = 'none';
                detailsContentContainer.innerHTML = '';
                return;
            }

            const selectedSchool = schools.find(function(s) { return s.id === selectedSchoolId; });
            if (!selectedSchool) {
                detailsPlaceholder.innerHTML = '<p>Error: School data not found.</p>';
                detailsPlaceholder.style.display = 'block';
                detailsContentContainer.style.display = 'none';
                return;
            }

            detailsPlaceholder.style.display = 'none';
            detailsContentContainer.style.display = 'block';

            // Clear previous content
            detailsContentContainer.innerHTML = '';

            // Create the school title as h1
            const titleElement = document.createElement('h1');
            titleElement.textContent = selectedSchool.name;
            detailsContentContainer.appendChild(titleElement);

            // Create wrapper for the AI description content
            const infoDiv = document.createElement('div');
            infoDiv.className = 'school-info-wrapper';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'school-content';
            contentDiv.innerHTML = selectedSchool.ai_description_html;

            infoDiv.appendChild(contentDiv);
            detailsContentContainer.appendChild(infoDiv);
        });
    </script>
</body>
</html>
